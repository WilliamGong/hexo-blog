---
title: 从零开始搭建 Home Lab 2 Proxmox VE 的搭建
date: 2021-05-06T15:03:24+08:00
toc: true
cover:
thumbnail:
categories:
    - Home Lab
tags:
    - Linux
    - Proxmox VE
---
在硬件和 BIOS 配置完成后，就要着手开始搭建 Hypervisor 了。     
因为要跑的客户机基本都是 Linux，所以使用基于 KVM 和 QEMU 的 Hypervisor 显然要更好。     
所以我选择了 PVE，虽然每次管理都要看一遍订阅提醒就很烦。     
> 当然，用 QEMU 加上 WebVirtMgr 自己糊一个 Hypervisor 也是可以的，我之前本来要使用这个方案的。     
但毕竟稳定性最重要，而自己糊的肯定比不上专业的，而且看了看 PVE 的手册后……真香。      

# Proxmox VE 的安装
> 本 Blog 不会写出完整安装过程，只有在安装时的注意事项和各种坑。毕竟安装这玩意就比安装 Debian 复杂一点，看手册就行了。    
推荐这篇 Proxmox VE 6.2 的翻译版手册，虽然是 6.2 版本稍微有点老，但可参考性还是不用担心的。      
这里是链接：[Proxmox6.2中文手册](https://www.proxmox.wiki/?thread-137.htm)     
在此感谢翻译该手册的大佬。

## 挂载安装 ISO
HPE Gen 10 Plus 具有网络挂载 ISO 的功能，直接提供 ISO 的 URL 就行了。但这功能只有在网速极快（比如千兆/万兆内网内有装有 ISO 的 NAS）的环境下才有意义。      
如果在大多数情况下使用该功能的话，就是一杯茶，一包烟，ISO 载入看一天了。     
> 因为这个功能是直接挂载，而不是下载到本地再加载。    
毕竟想想也是，硬盘都还没分区表呢下载的文件放哪？    
天真的我之前一度以为这功能是自动下载后在加载……蠢哭了。

所以老老实实做启动 U 盘吧。记得插在机器后面的 USB 插槽上。
当然，从 Debian 上安装 Proxmox VE 也是可以的，但此处不过多说明，详情请见手册。
## 分区设置
Proxmox VE 的分区设置很奇怪，坑也很多，所以我也没研究透，但此处我在此写下我遇到的坑以及些许建议。
首先，安装 PVE 时，只能在一块盘上进行分区，所以像我这样有多硬盘的数据盘在安装完成后再分区吧。    
在选择分区硬盘的旁边有 Options 的高级设置，可以设置分区的文件系统，但此处不建议改动，最多取消掉 swap 分区（此机器的 Hypervisor 上使用 swap 没有意义，尤其是我上了 32G 内存），除非你知道自己在做什么。     
在 PVE 的默认分区方案下，硬盘会分别生成一个 bios 启动分区，一个 EFI 分区，剩下的空间会被划分为叫做 pve 的 lVM 卷组，里面是 root, data, swap 逻辑卷。     
对于 data 卷，该分区就是 PVE 存储各种数据的分区，在安装后的管理界面上有两个卷，分别是 local 和 local-lvm，就是在 data 卷里的。其中 local 卷存储各种 ISO 镜像和容器模板，而 local-lvm 则存储虚拟机硬盘和容器。      
如要取消 swap，则将 Options 中的 swapsize 设置为 0。     
当然，在多硬盘情况下，可以取消 data 卷，将 maxvz 设置为 0 即可（但我没试验过，慎用）。      
> 别问我为什么会同时有 bios 启动分区和 esp，我也不知道。

## 地点，时区设置
PVE 的地点设置不是选择的，需要自己输入，输入 China 就好。     
对于时区，选择 Asia/Shanghai 或 Asia/HongKong 都行，都是 GMT+8。      

# 安装后的配置
## 网络管理界面
PVE 的网络管理界面地址默认是本机 IP:8006，开机后机器如果链接 tty 的话会显示这个地址。
## 用户
在 PVE 的管理界面，设置用户很简单，但在我的使用场景下，只用 root 就足够了。如果有多个用户要维护 PVE 的话，可以看看 PVE 复杂的权限系统。      
## ZFS 配置
管理界面创建 zpool 储存池也很方便，单盘创建 zpool 或创建 raidz 都不难，还可以设置各种参数和选项，比如我就打开了压缩功能。     
对了，zpool 创建时是以硬盘为单位，创建 zpool 需要至少一块硬盘。      
此外，ZFS 对内存的要求很高，现在推荐的使用 ZFS 的最小内存容量为基础 4G，zpool 总容量每 1T 额外加 1G。     
而且 ZFS 在使用时会将大量内存用作缓存，我的机器平时运行就用了 20G+，而其中虚拟机的内存一共 10G。不过可以设置 ZFS 的内存使用上限，在 /etc/modprobe.d/zfs.conf 中输入`options zfs zfs_arc_max=[number]`即可。`[number]`为你想要设置的上限。    
当然，也可以为储存池设置 SSD 缓存盘或 ZIL 日志盘，比如在我的分区方案下，SSD 上不设置 data 卷，剩余空间作为缓存盘，可以改善 ZFS 的性能。    
> 但我还是想把一部分虚拟机硬盘放在 SSD 上。